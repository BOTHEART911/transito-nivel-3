<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>3. ¬°Adivina T√©rminos!</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Favicon -->
  <link rel="icon" href="https://res.cloudinary.com/dqqeavica/image/upload/v1756743104/Logo_rkja6o.png" type="image/png">
  <!-- TailwindCSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- SweetAlert CDN -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    .game-btn:active { transform: scale(0.98);}
    .stage-bg { background: linear-gradient(135deg, #dbeafe 60%, #fef08a 100%);}
    .shake { animation: shake 0.4s;}
    @keyframes shake {
      0% { transform: translateX(0);}
      20% { transform: translateX(-8px);}
      40% { transform: translateX(8px);}
      60% { transform: translateX(-4px);}
      80% { transform: translateX(4px);}
      100% { transform: translateX(0);}
    }
    .tr√°nsito-entity-img {
      width: 60px;
      max-width: 22vw;
      margin-bottom: 0.5rem;
      border-radius: 1rem;
      box-shadow: 0 4px 24px #0001;
      display: block;
    }
    .avatar-img {
      width: 70px;
      height: 95px;
      object-fit: contain;
      border-radius: 16px;
      background: #fff;
      box-shadow: 0 2px 12px #0002;
      border: 2px solid #e0e7ff;
      margin: 0 auto;
      transition: box-shadow 0.2s, border 0.2s;
    }
    .avatar-img.selected {
      box-shadow: 0 0 0 4px #fde047;
      border-color: #f59e42;
    }
    .volver-btn {
      position: absolute;
      top: 10px;
      left: 12px;
      z-index: 40;
    }
    .confetti {
      position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh; pointer-events: none;
      z-index: 100;
      overflow: hidden;
    }
    .confetti-piece {
      position: absolute;
      width: 14px; height: 14px;
      border-radius: 3px;
      opacity: 0.85;
      animation: confetti-fall 1.8s cubic-bezier(.62,.02,.37,.99) forwards;
    }
    @keyframes confetti-fall {
      0% { transform: translateY(-20px) rotate(0deg); opacity: 1;}
      80% { opacity: 1;}
      100% { transform: translateY(90vh) rotate(360deg); opacity: 0;}
    }
    .aprobado-txt {
      font-size: 2.2rem;
      font-weight: bold;
      color: #10b981;
      background: linear-gradient(90deg,#fef08a 20%,#a7f3d0 80%);
      padding: 0.35em 1em;
      border-radius: 2em;
      box-shadow: 0 4px 24px #eab30833;
      margin-bottom: 1em;
      animation: aprobadoPulse 1.1s infinite alternate;
    }
    @keyframes aprobadoPulse {
      0% { transform: scale(1);}
      100% { transform: scale(1.08);}
    }
    .codigo-premio {
      font-size: 1.5rem;
      background: #fbbf24;
      color: #fff;
      padding: 0.3em 1em;
      border-radius: 1.2em;
      font-weight: bold;
      box-shadow: 0 2px 8px #f59e4233;
      letter-spacing: 2px;
      margin-bottom: 1em;
    }
    .modal-juego {
      border-radius: 1em !important;
      padding: 1.2em 0.7em !important;
      min-height: unset !important;
    }
    .pregunta-txt, .nivel-txt, .text-lg, .text-xl, .font-bold {
      font-size: 1.2rem !important;
      line-height: 1.2 !important;
    }
    .game-btn, .opcion-btn {
      padding: 0.7em 0.7em !important;
      font-size: 1.1rem !important;
    }
    .guion-letra {
      font-size: 2.2rem;
      font-family: 'Courier New', Courier, monospace;
      letter-spacing: 0.12em;
      margin: 0.1em 0.1em;
    }
    .timer {
      font-size: 1.3rem;
      font-weight: bold;
      color: #eab308;
      background: #fef08a;
      padding: 0.2em 1em;
      border-radius: 1.4em;
      box-shadow: 0 2px 8px #fde04722;
      margin-bottom: 1em;
      display: inline-block;
    }

    /* Carros */
    .cars-wrap {
      position: relative;
      width: 100%;
      height: 80px;
      margin-bottom: 6px;
    }
    .car-img {
      position: absolute;
      top: 4px;
      width: clamp(44px, 10vw, 78px);
      height: auto;
      transition: left 0.35s ease, right 0.35s ease, transform 0.25s ease;
      filter: drop-shadow(0 4px 6px rgba(0,0,0,0.15));
    }

    @media (max-width:600px) {
      .avatar-img { width: 48px; height: 68px; }
      .max-w-md, .max-w-lg { max-width: 95vw !important;}
      .guion-letra { font-size: 1.5rem;}
      .pregunta-txt, .nivel-txt { font-size: 0.95rem !important;}
    }
    @media (max-width:480px) {
      .rounded-3xl, .modal-juego {
        border-radius: 1em !important;
        padding: 0.5em 0.3em !important;
        min-height: unset !important;
      }
      .pregunta-txt, .nivel-txt, .text-lg, .text-xl, .font-bold {
        font-size: 0.95rem !important;
        line-height: 1.2 !important;
      }
      .game-btn, .opcion-btn {
        padding: 0.7em 0.4em !important;
        font-size: 1rem !important;
      }
      .max-w-md, .max-w-lg { max-width: 98vw !important; }
    }
  </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center bg-gradient-to-bl from-blue-100 to-yellow-100">
  <div id="app" class="w-full max-w-2xl mx-auto mt-4 relative"></div>
  <div id="confetti"></div>

  <!-- SONIDOS -->
  <audio id="audio-inicio"   src="https://res.cloudinary.com/dqqeavica/video/upload/v1756841760/intro_b1nuvu.mp3" preload="auto"></audio>
  <audio id="audio-tictac"   src="https://res.cloudinary.com/dqqeavica/video/upload/v1756843183/tictoc_j7oje6.mp3" preload="auto"></audio>
  <audio id="audio-bien"     src="https://res.cloudinary.com/dqqeavica/video/upload/v1756844320/correcto_svttl1.mp3" preload="auto"></audio>
  <audio id="audio-mal"      src="https://res.cloudinary.com/dqqeavica/video/upload/v1756844319/incorrecto_h5vgbl.mp3" preload="auto"></audio>
  <audio id="audio-fin"      src="https://res.cloudinary.com/dqqeavica/video/upload/v1756844514/final_ein36c.mp3" preload="auto"></audio>
  <audio id="audio-fiesta"   src="https://res.cloudinary.com/dqqeavica/video/upload/v1756844514/ganar_tfdnmh.mp3" preload="auto"></audio>

  <script>
    // --- CONSTANTES ---
    const CODIGO_PREMIO = "STT1109";
    const FELICITACION = "¬°Haz completado el tercer nivel, eres un Guardi√°n Digital de la Seguridad Vial!";
    const TIEMPO_PREGUNTA = 60; // segundos por pregunta
    const MINIMO_ACIERTOS = 15;

    // Avatares
    const AVATARS = [
      "https://res.cloudinary.com/dqqeavica/image/upload/v1756828158/avatar_1_gjnwup.png",
      "https://res.cloudinary.com/dqqeavica/image/upload/v1756828158/avatar_2_om3ufg.png",
      "https://res.cloudinary.com/dqqeavica/image/upload/v1756828158/avatar_3_dswwyx.png",
      "https://res.cloudinary.com/dqqeavica/image/upload/v1756828158/avatar_4_rhcecg.png",
      "https://res.cloudinary.com/dqqeavica/image/upload/v1756828159/avatar_5_yx0wam.png",
      "https://res.cloudinary.com/dqqeavica/image/upload/v1756828159/avatar_6_gdxczb.png"
    ];

    // Precarga desde par√°metros de la URL (si viene del Nivel 2)
    const _params = new URLSearchParams(window.location.search);
    const _paramNombre = (_params.get('nombre') || '').trim();
    const _paramAvatarRaw = parseInt(_params.get('avatar'), 10);
    const _paramAvatar = Number.isFinite(_paramAvatarRaw) && _paramAvatarRaw >= 0 && _paramAvatarRaw < AVATARS.length ? _paramAvatarRaw : 0;

    // --- PREGUNTAS Y RESPUESTAS ---
    const PREGUNTAS = [
  {
    term: "ACERA O ANDEN",
    def: "Franja de la v√≠a destinada solo al paso de peatones, ubicada a los costados.",
    tarea: "Sal con tus padres y se√±ala una acera o and√©n, expl√≠cale por qu√© es importante para los peatones."
  },
  {
    term: "ACCIDENTES DE TRANSITO",
    def: "Suceso con un veh√≠culo en movimiento que causa da√±os a personas o bienes y afecta la circulaci√≥n.",
    tarea: "Pregunta a tus padres si han presenciado un accidente de tr√°nsito y conversa sobre c√≥mo evitarlos."
  },
  {
    term: "AGENTE DE TRANSITO",
    def: "Funcionario autorizado para regular y vigilar la circulaci√≥n vehicular y peatonal.",
    tarea: "Observa a un agente de tr√°nsito y comenta cu√°l es su funci√≥n."
  },
  {
    term: "AUTOPISTA",
    def: "V√≠a con calzadas separadas y varios carriles, dise√±ada para altas velocidades y sin cruces directos.",
    tarea: "Identifica una autopista en tu ciudad y comenta sus caracter√≠sticas."
  },
  {
    term: "CARRETERA",
    def: "V√≠a para la circulaci√≥n de veh√≠culos con condiciones de seguridad y comodidad.",
    tarea: "Dibuja una carretera y explica su importancia."
  },
  {
    term: "CARRIL",
    def: "Parte de la calzada destinada al tr√°nsito en una sola fila de veh√≠culos.",
    tarea: "Observa los carriles en una v√≠a y comenta por qu√© son importantes."
  },
  {
    term: "CASCO",
    def: "Protecci√≥n para la cabeza contra golpes que no limita la visi√≥n.",
    tarea: "Dibuja un casco y explica por qu√© debes usarlo."
  },
  {
    term: "CHOQUE O COLISION",
    def: "Impacto entre veh√≠culos o de un veh√≠culo con otro objeto.",
    tarea: "Explica a tu familia c√≥mo evitar un choque o colisi√≥n."
  },
  {
    term: "CICLORUTA",
    def: "V√≠a destinada √∫nicamente al tr√°nsito de bicicletas.",
    tarea: "Identifica una ciclorruta y comenta su utilidad."
  },
  {
    term: "CICLOMOTOR",
    def: "Bicicleta que puede ser impulsada tambi√©n por un peque√±o motor.",
    tarea: "Busca im√°genes de ciclomotores y explica c√≥mo funcionan."
  },
  {
    term: "CINTURON DE SEGURIDAD",
    def: "Sistema de correas que asegura al ocupante del veh√≠culo y reduce lesiones en accidentes.",
    tarea: "Dibuja un cintur√≥n de seguridad y explica su funci√≥n."
  },
  {
    term: "COMPARENDO",
    def: "Notificaci√≥n formal a quien incumple una norma de tr√°nsito.",
    tarea: "Observa un comparendo y explica por qu√© es importante cumplir las normas."
  },
  {
    term: "ESTACIONAMIENTO",
    def: "Lugar donde se permite parquear veh√≠culos de forma temporal.",
    tarea: "Identifica un estacionamiento y explica para qu√© sirve."
  },
  {
    term: "INFRACCION",
    def: "Violaci√≥n de una norma de tr√°nsito.",
    tarea: "Explica a tu familia qu√© es una infracci√≥n y c√≥mo evitarla."
  },
  {
    term: "PEATON",
    def: "Persona que camina por una v√≠a.",
    tarea: "Dibuja un peat√≥n y comenta por qu√© debe respetar las se√±ales."
  },
  {
    term: "PASAJERO",
    def: "Persona que viaja en un veh√≠culo, distinta al conductor.",
    tarea: "Explica la funci√≥n de un pasajero en el transporte p√∫blico."
  },
  {
    term: "SEM√ÅFORO",
    def: "Dispositivo luminoso que regula el paso de veh√≠culos y peatones.",
    tarea: "Observa un sem√°foro y comenta c√≥mo funciona."
  },
  {
    term: "SE√ëAL DE TRANSITO",
    def: "Dispositivo o marca que informa, previene o regula el tr√°nsito.",
    tarea: "Identifica una se√±al de tr√°nsito y explica su mensaje."
  },
  {
    term: "TRAFICO",
    def: "Cantidad de veh√≠culos, personas o productos que circulan por una v√≠a en un tiempo dado.",
    tarea: "Observa el tr√°fico en tu ciudad y comenta sus efectos."
  },
  {
    term: "TRANSITO",
    def: "Movimiento de personas, animales o veh√≠culos por una v√≠a p√∫blica.",
    tarea: "Explica el significado de tr√°nsito y su importancia."
  },
];

    // --- ESTADO DEL JUEGO ---
    let state = {
      screen: "inicio",
      playerName: _paramNombre,
      avatarIndex: _paramAvatar,
      sonido: true,
      salir: false,
      currentQ: 0,
      aciertos: 0,
      timer: null,
      timeLeft: TIEMPO_PREGUNTA,
      letrasEncontradas: [],
      letrasFallidas: [],
      tareasPendientes: [],
      winTimestamp: null,
      startTimestamp: null,
      preguntaRespondida: false, // para pausar el tiempo en modales
      failCount: 0,              // fallas de palabra (no letras)
      crashed: false             // bandera de choque
    };

    // --- UTILS ---
    function $(sel) { return document.querySelector(sel);}
    function appHtml(html) { $("#app").innerHTML = html; }
    function playSound(id) {
      if (!state.sonido) return;
      const audio = document.getElementById(id);
      if (audio) { audio.currentTime=0; audio.play(); }
    }
    function stopSound(id) {
      const audio = document.getElementById(id);
      if (audio) { audio.pause(); audio.currentTime=0; }
    }
    function playTicTac() {
      stopSound("audio-tictac");
      playSound("audio-tictac");
    }
    function stopTicTac() { stopSound("audio-tictac"); }

    // Confetti visual (sin sonido)
    function confettiVisual() {
      const colors = ["#fde047","#fbbf24","#10b981","#38bdf8","#f472b6","#6366f1","#f43f5e"];
      const confettiContainer = document.getElementById('confetti');
      const N = 70;
      confettiContainer.innerHTML = '';
      confettiContainer.className = 'confetti';
      for(let i=0; i<N; i++){
        const div = document.createElement('div');
        div.className = 'confetti-piece';
        div.style.background = colors[Math.floor(Math.random()*colors.length)];
        div.style.left = Math.random()*99+'vw';
        div.style.top = (Math.random()*10)+'vh';
        div.style.transform = `rotate(${Math.random()*360}deg)`;
        div.style.animationDelay = (Math.random()*0.7)+'s';
        confettiContainer.appendChild(div);
      }
      setTimeout(()=>{ confettiContainer.innerHTML=''; }, 1900);
    }

    // --- Vista Inicial ---
    function renderInicio() {
      stopTicTac();
      clearInterval(state.timer);
      state.timer = null;
      state.salir = false;
      appHtml(`
        <div class="bg-white rounded-3xl shadow-2xl p-8 flex flex-col items-center animate-fadeIn">
          <img src="https://res.cloudinary.com/dqqeavica/image/upload/v1756743104/secretaria_de_Transito_nxsvyp.jpg" alt="Secretar√≠a de Tr√°nsito" class="tr√°nsito-entity-img mb-3">
          <h1 class="text-4xl font-bold mb-3 text-yellow-600 text-center">Adivina T√©rminos</h1>
          <div class="mb-4 text-lg text-gray-700 text-center">Descubre los t√©rminos para convertirte en <br><span class="font-semibold text-blue-500">Guardi√°n Digital de la Seguridad Vial</span></div>
          <div class="flex flex-col items-center mb-3">
            <label class="mb-1 text-gray-600 font-medium">Nombre:</label>
            <input type="text" id="nombre" class="rounded-lg border-2 border-blue-200 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400 transition w-56 mb-2 text-center" maxlength="12" />
            <label class="mb-2 text-gray-600 font-medium">Elige tu avatar:</label>
            <div class="flex flex-row flex-wrap gap-3 justify-center items-center mb-2">
              ${AVATARS.map((url,i)=>`
                <img src="${url}" class="avatar-img${state.avatarIndex===i?' selected':''}" onclick="setAvatar(${i})" alt="avatar ${i+1}">
              `).join("")}
            </div>
          </div>
          <div class="mb-4 flex items-center justify-center gap-2">
            <button onclick="toggleSonido()" class="text-lg px-3 py-1 rounded-xl bg-yellow-200 hover:bg-yellow-300 font-bold">
              ${state.sonido ? "üîä Sonido ON" : "üîá Sonido OFF"}
            </button>
          </div>
          <button onclick="startGame()" class="game-btn bg-yellow-400 hover:bg-yellow-500 text-white font-bold px-8 py-3 rounded-xl shadow-xl text-2xl mt-2">¬°Jugar!</button>
          <div class="mt-4 text-sm text-gray-400">Copyright ¬© Oscar Polania - Sec. Tr√°nsito del Tolima</div>
        </div>
      `);
      const _in = document.getElementById('nombre');
      if (_in && state.playerName) _in.value = state.playerName;
      playSound("audio-inicio");
      window.setAvatar = (i)=>{state.avatarIndex=i; renderInicio();}
      window.toggleSonido = ()=>{state.sonido=!state.sonido; renderInicio();}
    }

    // --- Juego Principal ---
    function startGame() {
      let nombre = state.playerName;
      if (state.screen === "inicio") {
        const inp = $("#nombre");
        nombre = inp ? inp.value.trim() : nombre;
        if (nombre.length < 2) {
          if (inp) { inp.classList.add('shake'); setTimeout(()=>inp.classList.remove('shake'), 400); }
          return;
        }
      }
      stopSound("audio-inicio"); // evitar superposici√≥n
      state.playerName = nombre;
      state.screen = "juego";
      state.salir = false;
      state.currentQ = 0;
      state.aciertos = 0;
      state.tareasPendientes = [];
      state.winTimestamp = null;
      state.startTimestamp = Date.now();
      state.failCount = 0;
      state.crashed = false;
      setupPregunta();
      renderPregunta();
      startTimer();
    }

    function setupPregunta() {
      state.letrasEncontradas = [];
      state.letrasFallidas = [];
      state.timeLeft = TIEMPO_PREGUNTA;
      state.preguntaRespondida = false;
    }

    function startTimer() {
      clearInterval(state.timer);
      state.timer = setInterval(()=>{
        if(state.salir || state.preguntaRespondida) {
          clearInterval(state.timer);
          return;
        }
        state.timeLeft--;
        renderTimerUI();
        if(state.timeLeft<=0){
          clearInterval(state.timer);
          stopTicTac();
          // tiempo agotado: falla de palabra
          nextPregunta(false);
        }
      },1000);
      playTicTac();
    }

    function renderTimerUI() {
      if ($("#timer-ui")) $("#timer-ui").textContent = state.timeLeft;
    }

    function renderPregunta() {
      if(state.salir) return;
      state.screen = "juego";
      const pregunta = PREGUNTAS[state.currentQ];

      // Progreso de acercamiento de carros: 0..1 (m√°x 6 fallas)
      const progress = Math.min(state.failCount, 6) / 6;
      // Distancia lateral desde los bordes al centro (%). 2% -> 48% en 6 pasos.
      const stepPct = (2 + (46 * progress)).toFixed(2);

      appHtml(`
        <div class="rounded-3xl shadow-2xl p-4 sm:p-7 flex flex-col items-center w-full stage-bg animate-fadeIn min-h-[420px] relative modal-juego" id="modal-pregunta">
          <div class="flex flex-row w-full justify-between items-start mb-2 relative">
            <div class="flex flex-col items-center" style="min-width:85px;">
              <button onclick="salirAJugar()" class="btn-salir mb-2" style="align-self: flex-start;">‚ùå Salir</button>
              <img src="${AVATARS[state.avatarIndex]}" class="avatar-img mb-1" alt="Avatar">
              <span class="text-blue-700 font-bold text-lg mt-1">${state.playerName}</span>
            </div>
            <img src="https://res.cloudinary.com/dqqeavica/image/upload/v1756743104/secretaria_de_Transito_nxsvyp.jpg" class="tr√°nsito-entity-img ml-3 mt-2" alt="Secretar√≠a de Tr√°nsito">
          </div>

          <span class="font-bold text-xl text-yellow-700 nivel-txt mb-1">Nivel 3 - Adivina el T√©rmino</span>

          <div class="pregunta-txt text-center mb-2">
            ${pregunta.def}
          </div>

          <!-- Carros acerc√°ndose sobre el √°rea del t√©rmino -->
          <div class="cars-wrap">
            <img src="https://res.cloudinary.com/dqqeavica/image/upload/v1758566037/auto_gs8jkq.png" alt="Auto 1" class="car-img" style="left: ${stepPct}%;">
            <img src="https://res.cloudinary.com/dqqeavica/image/upload/v1758566037/auto_gs8jkq.png" alt="Auto 2" class="car-img" style="right: ${stepPct}%; transform: scaleX(-1);">
          </div>

          <div class="w-full flex flex-col items-center mb-4">
            <span class="timer" id="timer-ui">${state.timeLeft}</span>
            <div class="flex flex-wrap items-center justify-center mb-2">
              ${renderGuiones(pregunta.term)}
            </div>
          </div>

          <div class="w-full flex flex-row gap-5 justify-center mt-2 mb-2">
            <button onclick="abrirModalLetra()" class="game-btn bg-blue-600 hover:bg-blue-700 text-white font-bold px-5 py-2 rounded-xl shadow-xl text-xl" ${faltanLetras(pregunta.term) <= 1 ? "disabled" : ""}>Letra</button>
            <button onclick="abrirModalRespuesta()" class="game-btn bg-green-600 hover:bg-green-700 text-white font-bold px-5 py-2 rounded-xl shadow-xl text-xl">Responder</button>
          </div>

          <div class="flex justify-between w-full mt-2 mb-1 items-center">
            <span class="text-md font-bold text-blue-700">Aciertos: ${state.aciertos}</span>
            <span class="text-md font-bold text-yellow-700">Pregunta: ${state.currentQ+1} / ${PREGUNTAS.length}</span>
          </div>
        </div>
      `);
      window.abrirModalLetra = abrirModalLetra;
      window.abrirModalRespuesta = abrirModalRespuesta;
      window.salirAJugar = salirAJugar;
    }

    function renderGuiones(term) {
      let termUpper = term.toUpperCase();
      let html = "";
      for (let i = 0; i < termUpper.length; i++) {
        let letra = termUpper[i];
        if (letra === " ") {
          html += `<span class="guion-letra" style="width:24px;color:#fff;">&nbsp;</span>`;
        } else if (state.letrasEncontradas.includes(letra)) {
          html += `<span class="guion-letra" style="color:#10b981;font-weight:bold;">${letra}</span>`;
        } else {
          html += `<span class="guion-letra">_</span>`;
        }
      }
      return html;
    }

    function abrirModalLetra() {
      state.preguntaRespondida = true;
      stopTicTac();
      Swal.fire({
        html: `
          <div class="flex flex-col items-center mt-2">
            <div class="font-bold text-2xl mb-2">Ingresa la letra</div>
            <input type="text" id="input-letra" class="rounded-lg border-2 text-center px-4 py-2 mb-3" maxlength="1" style="width:65px;font-size:2rem;">
            <div class="flex flex-row gap-3 mt-2">
              <button id="btn-ingresar-letra" class="swal2-confirm game-btn bg-green-600 text-white font-bold px-4 py-2 rounded-lg" disabled>Ingresar</button>
              <button id="btn-atras-letra" class="swal2-cancel game-btn bg-blue-600 text-white font-bold px-4 py-2 rounded-lg">Atr√°s</button>
            </div>
          </div>
        `,
        showConfirmButton: false,
        showCancelButton: false,
        customClass: {popup: 'rounded-2xl modal-juego'},
        didOpen: () => {
          const input = $("#input-letra");
          const btnIn = $("#btn-ingresar-letra");
          const btnBack = $("#btn-atras-letra");
          input.focus();
          input.addEventListener("input", ()=>{
            btnIn.disabled = input.value.trim().length!==1;
          });
          btnIn.addEventListener("click", ()=>{
            ingresarLetra(input.value.trim().toUpperCase());
            Swal.close();
          });
          btnBack.addEventListener("click", ()=>{
            Swal.close();
            state.preguntaRespondida = false;
            startTimer();
          });
        }
      });
    }

    function ingresarLetra(letra) {
      if (!letra || letra.length !== 1) return;
      const pregunta = PREGUNTAS[state.currentQ];
      let termUpper = pregunta.term.toUpperCase();
      if (termUpper.includes(letra)) {
        if (!state.letrasEncontradas.includes(letra)) state.letrasEncontradas.push(letra);
        playSound("audio-bien");
        Swal.fire({
          position: 'top',
          icon: 'success',
          title: '¬°Letra encontrada!',
          showConfirmButton: false,
          timer: 1600,
          customClass: {popup: 'rounded-2xl modal-juego'}
        }).then(()=>{
          state.preguntaRespondida = false;
          startTimer();
          renderPregunta();
        });
      } else {
        if (!state.letrasFallidas.includes(letra)) state.letrasFallidas.push(letra);
        playSound("audio-mal");
        Swal.fire({
          position: 'top',
          icon: 'error',
          title: 'Letra no existe',
          showConfirmButton: false,
          timer: 1600,
          customClass: {popup: 'rounded-2xl modal-juego'}
        }).then(()=>{
          state.preguntaRespondida = false;
          startTimer();
          renderPregunta();
        });
      }
    }

   function abrirModalRespuesta() {
  state.preguntaRespondida = true;
  stopTicTac();
  Swal.fire({
    html: `
      <div class="flex flex-col items-center mt-2">
        <div class="font-bold text-2xl mb-2">Ingresa la Respuesta</div>
        <input type="text" id="input-respuesta" class="rounded-lg border-2 text-center px-4 py-2 mb-3" maxlength="40" style="width:220px;font-size:1.2rem;">
        <div class="flex flex-row gap-3 mt-2">
          <button id="btn-ingresar-resp" class="swal2-confirm game-btn bg-green-600 text-white font-bold px-4 py-2 rounded-lg" disabled>Responder</button>
          <button id="btn-atras-resp" class="swal2-cancel game-btn bg-blue-600 text-white font-bold px-4 py-2 rounded-lg">Atr√°s</button>
        </div>
      </div>
    `,
    showConfirmButton: false,
    showCancelButton: false,
    customClass: {popup: 'rounded-2xl modal-juego'},
    didOpen: () => {
      const input = $("#input-respuesta");
      const btnResp = $("#btn-ingresar-resp");
      const btnBack = $("#btn-atras-resp");
      input.focus();
      input.addEventListener("input", ()=>{
        btnResp.disabled = input.value.trim().length < 1;
      });
      btnResp.addEventListener("click", ()=>{
        const valor = input.value.trim();
        Swal.close();              // 1) cerrar primero el modal actual
        setTimeout(()=>{           // 2) en el siguiente tick, abrir la alerta de resultado
          ingresarRespuesta(valor);
        }, 0);
      });
      btnBack.addEventListener("click", ()=>{
        Swal.close();
        state.preguntaRespondida = false;
        startTimer();
      });
    }
  });
}
    function normalizarTexto(txt) {
      return (txt||"").toUpperCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "") // quitar tildes
        .replace(/[^A-Z0-9 ]/g, ""); // quitar s√≠mbolos
    }

    function ingresarRespuesta(resp) {
  // Pausar inmediatamente timer y tictac
  state.preguntaRespondida = true;
  clearInterval(state.timer);
  stopTicTac();

  const pregunta = PREGUNTAS[state.currentQ];
  const esperado = normalizarTexto(pregunta.term);
  const recibido = normalizarTexto(resp);
  const esCorrecto = recibido === esperado;

  // Sonido (ya sin tictac)
  playSound(esCorrecto ? "audio-bien" : "audio-mal");

  // Mostrar alerta con t√©rmino y definici√≥n
  mostrarAlertaResultado(esCorrecto, pregunta).then(()=>{
    nextPregunta(esCorrecto); // aqu√≠ se reanuda flujo (y timer en la siguiente pregunta)
  });
}

    function mostrarAlertaResultado(esCorrecto, pregunta) {
  const title = esCorrecto ? '¬°Correcto!' : 'Respuesta incorrecta';
  const icon = esCorrecto ? 'success' : 'error';

  return Swal.fire({
    icon,
    html: `
      <div class="flex flex-col items-center gap-2 mt-1">
        <div class="font-bold text-2xl ${esCorrecto ? 'text-green-600' : 'text-red-600'} mb-1">${title}</div>
        <div class="text-blue-700 font-bold">T√©rmino:</div>
        <div class="text-xl font-extrabold text-blue-900">${pregunta.term}</div>
        <div class="text-gray-700 text-base mt-2 text-center">${pregunta.def}</div>
        ${pregunta.tarea ? `<div class="text-sm text-amber-700 bg-amber-100 px-3 py-2 rounded-lg mt-2">Tarea: ${pregunta.tarea}</div>` : ''}
      </div>
    `,
    confirmButtonText: 'Continuar',
    showConfirmButton: true,
    allowOutsideClick: false,
    allowEscapeKey: false,
    customClass: { popup: 'rounded-2xl modal-juego' }
  });
}
    
    function faltanLetras(term) {
      let termUpper = term.toUpperCase();
      let total = 0;
      for (let i=0; i<termUpper.length; i++) {
        let letra = termUpper[i];
        if (letra !== " " && !state.letrasEncontradas.includes(letra)) total++;
      }
      return total;
    }

    function nextPregunta(acierto) {
      state.preguntaRespondida = false;
      stopTicTac();
      clearInterval(state.timer);

      if (acierto) {
        state.aciertos++;
        if (PREGUNTAS[state.currentQ].tarea) {
          state.tareasPendientes.push(PREGUNTAS[state.currentQ].tarea);
        }
      } else {
        // Falla de palabra: acercar carros
        state.failCount++;
        if (state.failCount >= 6) {
          // Choque: terminar juego
          state.crashed = true;
          stopTicTac();
          playSound("audio-fin");
          Swal.fire({
            icon: 'error',
            title: '¬°Choque!',
            text: 'Has acumulado 6 fallas. Fin del juego.',
            confirmButtonText: 'Aceptar',
            customClass: {popup: 'rounded-2xl modal-juego'}
          }).then(()=>{
            renderFin();
          });
          return;
        }
      }

      // Avanzar o finalizar
      if (state.currentQ < PREGUNTAS.length-1) {
        state.currentQ++;
        setupPregunta();
        renderPregunta();
        startTimer();
      } else {
        // Fin del juego
        state.winTimestamp = Date.now();
        renderFin();
      }
    }

    function salirAJugar() {
      state.salir = true;
      renderInicio();
    }

    // --- FIN DEL JUEGO ---
    function renderFin() {
      stopTicTac();
      clearInterval(state.timer);
      state.screen = "fin";
      const aprobado = !state.crashed && state.aciertos >= MINIMO_ACIERTOS;
      if (aprobado) {
        setTimeout(confettiVisual, 100);
        playSound("audio-bien"); // sonido de acierto al ganar
      }
      appHtml(`
        <div class="bg-white rounded-3xl shadow-2xl p-8 flex flex-col items-center animate-fadeIn relative">
          <img src="https://res.cloudinary.com/dqqeavica/image/upload/v1756743104/secretaria_de_Transito_nxsvyp.jpg" alt="Secretar√≠a de Tr√°nsito" class="tr√°nsito-entity-img mb-3">
          <img src="${AVATARS[state.avatarIndex]}" class="avatar-img" alt="Avatar" style="margin-bottom:0.5em">
          <h2 class="text-3xl font-bold text-yellow-700 mb-2">${aprobado?FELICITACION:"¬°Int√©ntalo de nuevo!"}</h2>
          <div class="text-lg font-medium text-blue-600 mb-2">Terminaste el nivel de adivinar t√©rminos.</div>
          <div class="mb-2 text-xl font-bold text-yellow-500">Aciertos: <span class="text-blue-900">${state.aciertos}</span> / ${PREGUNTAS.length}</div>
          ${
            aprobado 
            ? `<div class="aprobado-txt">¬°Haz superado este reto! üéâ</div>
                <div class="codigo-premio">Tu c√≥digo de ganador: <span>${CODIGO_PREMIO}</span></div>
                <div class="text-green-600 font-bold text-lg mb-2 animate-bounce">¬°Eres un H√©roe Vial!</div>`
            : `<div class="text-pink-700 font-bold text-lg mb-2 animate-pulse">
                  ¬°Sigue intentando hasta lograrlo!
               </div>`
          }
          <div class="mb-4">
            <!-- Bot√≥n solicitado: Genera tu Menci√≥n (sin pasar datos) -->
            <div class="mb-2">
              <a href="https://botheart911.github.io/transito-certificacion/" class="game-btn px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-bold">Genera tu Menci√≥n</a>
            </div>
            <!-- Mantener Ver tareas para casa -->
            <button onclick="verTareas()" class="game-btn bg-green-400 hover:bg-green-500 text-white px-6 py-2 rounded-lg font-bold mt-1">Ver tareas para casa</button>
          </div>
          <div class="mt-2 flex flex-col gap-2">
            <button onclick="renderInicio()" class="game-btn px-4 py-2 bg-blue-200 hover:bg-blue-400 text-blue-900 rounded-lg font-bold">Volver al inicio</button>
            <button onclick="jugarDeNuevo()" class="game-btn px-4 py-2 bg-yellow-300 hover:bg-yellow-400 text-yellow-900 rounded-lg font-bold">Jugar de nuevo</button>
          </div>
          <div class="mt-4 text-gray-400 text-xs">Actividad pedag√≥gica Secretar√≠a de Tr√°nsito Departamental</div>
        </div>
      `);
      window.verTareas = verTareas;
      window.jugarDeNuevo = jugarDeNuevo;
    }

    function jugarDeNuevo() {
      state.salir = false;
      state.screen = "juego";
      startGame();
    }

    function verTareas() {
      appHtml(`
        <div class="bg-white rounded-3xl shadow-2xl p-8 flex flex-col items-center animate-fadeIn">
          <img src="https://res.cloudinary.com/dqqeavica/image/upload/v1756743104/secretaria_de_Transito_nxsvyp.jpg" alt="Secretar√≠a de Tr√°nsito" class="tr√°nsito-entity-img mb-3">
          <img src="${AVATARS[state.avatarIndex]}" class="avatar-img" alt="Avatar" style="margin-bottom:0.5em">
          <h2 class="text-2xl font-bold text-green-700 mb-3">Tareas para hacer en casa</h2>
          <ul class="mb-4 w-full max-w-lg text-base list-disc list-inside text-gray-700">
            ${state.tareasPendientes.length === 0 ? 
              `<li>¬°No hay tareas pendientes! Juega otra vez para conseguir nuevas tareas.</li>`
              : state.tareasPendientes.map(t=>`<li class="mb-2">${t}</li>`).join("")}
          </ul>
          <div class="mb-2">
            <button onclick="renderFin()" class="game-btn bg-yellow-300 hover:bg-yellow-500 text-white px-5 py-2 rounded font-bold">Volver</button>
          </div>
          <div class="text-gray-400 text-xs">Actividad pedag√≥gica Secretar√≠a de Tr√°nsito Departamental</div>
        </div>
      `);
    }

    // Lanzar el inicio al cargar
    renderInicio();
  </script>
</body>
</html>
